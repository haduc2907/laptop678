@model TTCSN.Models.Order.OrderListViewModel

@{
    ViewData["Title"] = "Đơn hàng của tôi";
}

<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-box"></i> Đơn hàng của tôi</h2>
            </div>

            @if (!Model.Orders.Any())
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-shopping-bag fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Bạn chưa có đơn hàng nào</h4>
                        <p class="text-muted">Hãy khám phá và mua sắm ngay!</p>
                        <a asp-controller="Product" asp-action="Index" class="btn btn-primary mt-3">
                            <i class="fas fa-shopping-cart"></i> Mua sắm ngay
                        </a>
                    </div>
                </div>
            }
            else
            {
                <!-- Filter Tabs -->
                <ul class="nav nav-pills mb-4" id="orderStatusTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="pill"
                                data-bs-target="#all" type="button" role="tab">
                            Tất cả
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-tab" data-bs-toggle="pill"
                                data-bs-target="#pending" type="button" role="tab">
                            Chờ xử lý
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="processing-tab" data-bs-toggle="pill"
                                data-bs-target="#processing" type="button" role="tab">
                            Đang xử lý
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="shipped-tab" data-bs-toggle="pill"
                                data-bs-target="#shipped" type="button" role="tab">
                            Đang giao
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="delivered-tab" data-bs-toggle="pill"
                                data-bs-target="#delivered" type="button" role="tab">
                            Đã giao
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cancelled-tab" data-bs-toggle="pill"
                                data-bs-target="#cancelled" type="button" role="tab">
                            Đã hủy
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="isreviewed-tab" data-bs-toggle="pill"
                                data-bs-target="#isreviewed" type="button" role="tab">
                            Đã đánh giá
						</button>
                </ul>

                <!-- Orders List -->
                <div class="tab-content" id="orderStatusTabContent">
                    @foreach (var order in Model.Orders)
                    {
                        <div class="card mb-3 order-card" data-status="@((int)order.Status)">
                            <div class="card-header bg-white">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h6 class="mb-0">
                                            <i class="fas fa-receipt"></i> Mã đơn hàng: <strong>#@order.Id</strong>
                                        </h6>
                                        <small class="text-muted">
                                            <i class="far fa-calendar"></i> @order.OrderDate.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <span class="badge @GetStatusBadgeClass(order.Status) fs-6">
                                            @GetStatusText(order.Status)
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-2">
                                            <i class="fas fa-map-marker-alt text-danger"></i>
                                            <strong>Địa chỉ giao hàng:</strong> @order.Address
                                        </div>
                                        <div class="mb-2">
                                            <i class="fas fa-phone text-success"></i>
                                            <strong>Số điện thoại:</strong> @order.PhoneNumber
                                        </div>
                                        <div class="mb-2">
                                            <i class="@GetPaymentMethodIcon(order.PaymentMethod)"></i>
                                            <strong>Thanh toán:</strong>
                                            <span class="badge @GetPaymentMethodBadgeClass(order.PaymentMethod)">
                                                @GetPaymentMethodText(order.PaymentMethod)
                                            </span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(order.Note))
                                        {
                                            <div class="mb-2">
                                                <i class="fas fa-sticky-note text-warning"></i>
                                                <strong>Ghi chú:</strong>
                                                <span class="text-muted">@order.Note</span>
                                            </div>
                                        }
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        <h4 class="text-danger mb-3">
                                            @order.TotalAmount.ToString("N0") đ
                                        </h4>
                                        <a asp-action="Details" asp-route-orderId="@order.Id"
                                           class="btn btn-outline-primary btn-sm mb-2 w-100">
                                            <i class="fas fa-eye"></i> Xem chi tiết
                                        </a>

                                        @if (order.Status == TTCSN.Entities.Enum.OrderStatus.Delivered)
                                        {
                                            <a asp-action="Details" asp-route-orderId="@order.Id"
                                               class="btn btn-warning btn-sm mb-2 w-100 d-flex align-items-center justify-content-center gap-2">
                                                <i class="fas fa-star"></i>
                                                <span>Đánh giá</span>
                                            </a>
                                        }

                                        @if (order.Status == TTCSN.Entities.Enum.OrderStatus.Pending)
                                        {
                                            <button type="button" class="btn btn-danger btn-sm btn-cancel w-100"
                                                    data-order-id="@order.Id">
                                                <i class="fas fa-times"></i> Hủy đơn
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-star text-warning"></i> Đánh giá đơn hàng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reviewOrderId">

                <!-- Rating Stars -->
                <div class="mb-4 text-center">
                    <h5 class="mb-3">Bạn cảm thấy sản phẩm như thế nào?</h5>
                    <div class="star-rating mb-2">
                        <i class="far fa-star star" data-rating="1"></i>
                        <i class="far fa-star star" data-rating="2"></i>
                        <i class="far fa-star star" data-rating="3"></i>
                        <i class="far fa-star star" data-rating="4"></i>
                        <i class="far fa-star star" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="ratingValue" value="5">
                    <p class="text-muted mb-0" id="ratingText">Tuyệt vời</p>
                </div>

                <!-- Review Comment -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-comment"></i> Nhận xét của bạn
                    </label>
                    <textarea id="reviewComment" class="form-control" rows="5"
                              placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm..."></textarea>
                    <small class="text-muted">Tối thiểu 10 ký tự</small>
                </div>

                <!-- Image Upload (Optional) -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-camera"></i> Thêm hình ảnh (tùy chọn)
                    </label>
                    <input type="file" id="reviewImages" class="form-control"
                           accept="image/*" multiple>
                    <small class="text-muted">Tối đa 5 hình ảnh</small>
                </div>

                <div id="imagePreview" class="d-flex flex-wrap gap-2 mb-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Đóng
                </button>
                <button type="button" class="btn btn-warning" id="btnSubmitReview">
                    <i class="fas fa-paper-plane"></i> Gửi đánh giá
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Xác nhận hủy đơn hàng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cancelOrderId">

                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i>
                    <strong>Lưu ý:</strong> Bạn chỉ có thể hủy đơn hàng khi đơn hàng đang ở trạng thái "Chờ xử lý".
                    Sau khi hủy, đơn hàng không thể hoàn tác.
                </div>

                <p class="mb-3"><strong>Bạn có chắc chắn muốn hủy đơn hàng này?</strong></p>

                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-list"></i> Lý do hủy đơn <span class="text-danger">*</span>
                    </label>
                    <select id="cancelReason" class="form-select" required>
                        <option value="">-- Chọn lý do --</option>
                        <option value="Đổi ý không muốn mua nữa">Đổi ý không muốn mua nữa</option>
                        <option value="Tìm được giá rẻ hơn ở nơi khác">Tìm được giá rẻ hơn ở nơi khác</option>
                        <option value="Đặt nhầm sản phẩm">Đặt nhầm sản phẩm</option>
                        <option value="Muốn thay đổi địa chỉ giao hàng">Muốn thay đổi địa chỉ giao hàng</option>
                        <option value="Thời gian giao hàng quá lâu">Thời gian giao hàng quá lâu</option>
                        <option value="Tìm thấy sản phẩm tốt hơn">Tìm thấy sản phẩm tốt hơn</option>
                        <option value="other">Lý do khác</option>
                    </select>
                </div>

                <!-- Additional Note - Only show when "Lý do khác" is selected -->
                <div class="mb-3" id="otherReasonContainer" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-edit"></i> Nhập lý do khác <span class="text-danger">*</span>
                    </label>
                    <textarea id="otherReasonText" class="form-control" rows="3"
                              placeholder="Vui lòng nhập lý do hủy đơn hàng của bạn..."></textarea>
                    <small class="text-muted">Giúp chúng tôi cải thiện dịch vụ tốt hơn</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmCancel">
                    <i class="fas fa-check"></i> Xác nhận hủy đơn
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .order-card {
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }

            .order-card:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                transform: translateY(-2px);
            }

            .order-card[data-status="0"] {
                border-left-color: #ffc107;
            }

            .order-card[data-status="1"] {
                border-left-color: #0dcaf0;
            }

            .order-card[data-status="2"] {
                border-left-color: #0d6efd;
            }

            .order-card[data-status="3"] {
                border-left-color: #198754;
            }

            .order-card[data-status="4"] {
                border-left-color: #dc3545;
            }

        .nav-pills .nav-link {
            color: #6c757d;
            border-radius: 20px;
            padding: 8px 20px;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

            .nav-pills .nav-link:hover {
                background-color: #e9ecef;
            }

            .nav-pills .nav-link.active {
                background-color: #0d6efd;
            }

        .star-rating {
            font-size: 2.5rem;
            cursor: pointer;
        }

        .star {
            color: #ddd;
            transition: all 0.2s ease;
            margin: 0 5px;
        }

            .star:hover,
            .star.active {
                color: #ffc107;
                transform: scale(1.1);
            }

        #imagePreview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

            #imagePreview img:hover {
                transform: scale(1.05);
                border-color: #0d6efd;
            }

        .btn-group-sm > .btn,
        .btn-sm {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        .modal-header.bg-danger {
            border-bottom: none;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        #otherReasonContainer {
            animation: slideDown 0.3s ease;
        }

        @@keyframes slideDown {
            from

        {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Filter orders by status
            $('button[data-bs-toggle="pill"]').on('click', function() {
                const targetTab = $(this).attr('data-bs-target');

                if (targetTab === '#all') {
                    $('.order-card').show();
                } else {
                    const statusMap = {
                        '#pending': 0,
                        '#processing': 1,
                        '#shipped': 2,
                        '#delivered': 3,
                        '#cancelled': 4,
						'#isreviewed': 5
                    };

                    const targetStatus = statusMap[targetTab];
                    $('.order-card').hide();
                    $(`.order-card[data-status="${targetStatus}"]`).show();
                }
            });

            // Star Rating
            let selectedRating = 5;

            $('.star').on('click', function() {
                selectedRating = $(this).data('rating');
                $('#ratingValue').val(selectedRating);

                $('.star').removeClass('active fas').addClass('far');

                for(let i = 1; i <= selectedRating; i++) {
                    $(`.star[data-rating="${i}"]`).removeClass('far').addClass('fas active');
                }
                updateRatingText(selectedRating);
            });

            $('.star').on('mouseenter', function() {
                const rating = $(this).data('rating');
                $('.star').removeClass('fas').addClass('far');

                for(let i = 1; i <= rating; i++) {
                    $(`.star[data-rating="${i}"]`).removeClass('far').addClass('fas');
                }
            });

            $('.star-rating').on('mouseleave', function() {
                $('.star').removeClass('fas active').addClass('far');

                for(let i = 1; i <= selectedRating; i++) {
                    $(`.star[data-rating="${i}"]`).removeClass('far').addClass('fas active');
                }
            });

            function updateRatingText(rating) {
                const texts = {
                    1: 'Rất tệ',
                    2: 'Tệ',
                    3: 'Bình thường',
                    4: 'Tốt',
                    5: 'Tuyệt vời'
                };
                $('#ratingText').text(texts[rating]);
            }

            // Initialize 5 stars
            for(let i = 1; i <= 5; i++) {
                $(`.star[data-rating="${i}"]`).removeClass('far').addClass('fas active');
            }

            // Image Preview
            $('#reviewImages').on('change', function(e) {
                const files = e.target.files;
                $('#imagePreview').empty();

                if (files.length > 5) {
                    showToast('error', 'Chỉ được tải lên tối đa 5 hình ảnh');
                    this.value = '';
                    return;
                }

                for(let i = 0; i < files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        $('#imagePreview').append(`
                            <img src="${event.target.result}" alt="Preview ${i + 1}">
                        `);
                    };
                    reader.readAsDataURL(files[i]);
                }
            });

            // Open Review Modal
            $('.btn-review').on('click', function() {
                const orderId = $(this).data('order-id');
                $('#reviewOrderId').val(orderId);

                // Reset form
                selectedRating = 5;
                $('#ratingValue').val(5);
                $('#reviewComment').val('');
                $('#reviewImages').val('');
                $('#imagePreview').empty();
                updateRatingText(5);

                $('.star').removeClass('far').addClass('fas active');
            });

            // Submit Review
            $('#btnSubmitReview').on('click', function() {
                const orderId = $('#reviewOrderId').val();
                const rating = $('#ratingValue').val();
                const comment = $('#reviewComment').val().trim();
                const btn = $(this);
                const originalText = btn.html();


                btn.html('<i class="fas fa-spinner fa-spin"></i> Đang gửi...').prop('disabled', true);

                const formData = new FormData();
                formData.append('orderId', orderId);
                formData.append('rating', rating);
                formData.append('comment', comment);

                // Add images
                const files = $('#reviewImages')[0].files;
                for(let i = 0; i < files.length; i++) {
                    formData.append('images', files[i]);
                }

                $.ajax({
                    url: '@Url.Action("SubmitReview", "Re")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#reviewModal').modal('hide');
                            showToast('success', 'Cảm ơn bạn đã đánh giá!');

                            // Hide review button for this order
                            $(`.btn-review[data-order-id="${orderId}"]`).remove();
                        } else {
                            showToast('error', response.message || 'Có lỗi xảy ra');
                        }
                        btn.html(originalText).prop('disabled', false);
                    },
                    error: function() {
                        showToast('error', 'Có lỗi xảy ra khi gửi đánh giá');
                        btn.html(originalText).prop('disabled', false);
                    }
                });
            });

            // Show/hide "Lý do khác" textarea when user selects "Lý do khác"
            $('#cancelReason').on('change', function() {
                if ($(this).val() === 'other') {
                    $('#otherReasonContainer').slideDown(300);
                    $('#otherReasonText').attr('required', true);
                } else {
                    $('#otherReasonContainer').slideUp(300);
                    $('#otherReasonText').attr('required', false).val('');
                }
            });

            // Open Cancel Modal
            $('.btn-cancel').on('click', function() {
                const orderId = $(this).data('order-id');
                $('#cancelOrderId').val(orderId);
                $('#cancelReason').val('');
                $('#otherReasonText').val('');
                $('#otherReasonContainer').hide();
                $('#cancelModal').modal('show');
            });

            // Confirm Cancel Order - SỬ DỤNG UpdateStatus
            $('#btnConfirmCancel').on('click', function() {
                const orderId = $('#cancelOrderId').val();
                const reasonSelect = $('#cancelReason').val();
                const otherReasonText = $('#otherReasonText').val().trim();
                const btn = $(this);
                const originalText = btn.html();

                // Validate reason
                if (!reasonSelect) {
                    showToast('error', 'Vui lòng chọn lý do hủy đơn');
                    $('#cancelReason').focus();
                    return;
                }

                // If "Lý do khác" is selected, check if user entered text
                if (reasonSelect === 'other') {
                    if (!otherReasonText) {
                        showToast('error', 'Vui lòng nhập lý do hủy đơn');
                        $('#otherReasonText').focus();
                        return;
                    }
                }

                // Determine final reason
                let finalReason = reasonSelect === 'other' ? otherReasonText : reasonSelect;
                let fullNote = `Lý do hủy: ${finalReason}`;

                btn.html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...').prop('disabled', true);

                $.ajax({
                    url: '@Url.Action("UpdateStatus", "Order")',
                    type: 'POST',
                    data: {
                        orderId: orderId,
                        status: 4, // OrderStatus.Cancelled = 4
                        note: fullNote
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#cancelModal').modal('hide');
                            showToast('success', 'Đơn hàng đã được hủy thành công');

                            // Reload page after 1.5s
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        } else {
                            showToast('error', response.message || 'Không thể hủy đơn hàng');
                        }
                        btn.html(originalText).prop('disabled', false);
                    },
                    error: function(xhr) {
                        let errorMessage = 'Có lỗi xảy ra khi hủy đơn hàng';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        showToast('error', errorMessage);
                        btn.html(originalText).prop('disabled', false);
                    }
                });
            });

            function showToast(type, message) {
                const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

                const toast = `
                    <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
                         style="top: 80px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                         role="alert">
                        <i class="fas ${icon}"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

                $('body').append(toast);

                setTimeout(function() {
                    $('.alert').fadeOut(300, function() { $(this).remove(); });
                }, 3000);
            }
        });
    </script>
}

@functions {
    string GetStatusBadgeClass(TTCSN.Entities.Enum.OrderStatus status)
    {
        return status switch
        {
            TTCSN.Entities.Enum.OrderStatus.Pending => "bg-warning text-dark",
            TTCSN.Entities.Enum.OrderStatus.Processing => "bg-info",
            TTCSN.Entities.Enum.OrderStatus.Shipped => "bg-primary",
            TTCSN.Entities.Enum.OrderStatus.Delivered => "bg-success",
            TTCSN.Entities.Enum.OrderStatus.Cancelled => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetStatusText(TTCSN.Entities.Enum.OrderStatus status)
    {
        return status switch
        {
            TTCSN.Entities.Enum.OrderStatus.Pending => "Chờ xử lý",
            TTCSN.Entities.Enum.OrderStatus.Processing => "Đang xử lý",
            TTCSN.Entities.Enum.OrderStatus.Shipped => "Đang giao hàng",
            TTCSN.Entities.Enum.OrderStatus.Delivered => "Đã giao hàng",
            TTCSN.Entities.Enum.OrderStatus.Cancelled => "Đã hủy",
            _ => "Không xác định"
        };
    }

    string GetPaymentMethodBadgeClass(TTCSN.Entities.Enum.PaymentMethods paymentMethod)
    {
        return paymentMethod switch
        {
            TTCSN.Entities.Enum.PaymentMethods.Cod => "bg-secondary",
            TTCSN.Entities.Enum.PaymentMethods.Vnpay => "bg-primary",
            _ => "bg-dark"
        };
    }

    string GetPaymentMethodIcon(TTCSN.Entities.Enum.PaymentMethods paymentMethod)
    {
        return paymentMethod switch
        {
            TTCSN.Entities.Enum.PaymentMethods.Cod => "fas fa-money-bill-wave",
            TTCSN.Entities.Enum.PaymentMethods.Vnpay => "fas fa-credit-card",
            _ => "fas fa-question"
        };
    }

    string GetPaymentMethodText(TTCSN.Entities.Enum.PaymentMethods paymentMethod)
    {
        return paymentMethod switch
        {
            TTCSN.Entities.Enum.PaymentMethods.Cod => "COD",
            TTCSN.Entities.Enum.PaymentMethods.Vnpay => "VNPay",
            _ => "Không xác định"
        };
    }
}